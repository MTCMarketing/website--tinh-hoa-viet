{"version":3,"file":"component---src-pages-test-auth-corruption-tsx-81d49b171fb2a25e978e.js","mappings":"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","sources":["webpack:///./src/pages/test/auth-corruption.tsx"],"sourcesContent":["\"use client\";\nimport React, { useState } from \"react\";\nimport { supabase } from \"../../database/supabaseClient\";\n\n// ======================================================\n// ğŸ§° CORRUPTION, HEALING, SESSION UTILITIES\n// ======================================================\n\n// Create the corruption exactly like the system failure\nfunction corruptSupabaseStorage() {\n  console.warn(\"ğŸ’¥ Simulating REAL corruption (race condition)â€¦\");\n\n  // 1. Write a valid session\n  const fake = {\n    currentSession: {\n      expires_at: Date.now() / 1000 + 3600,\n      access_token: \"FOO\",\n      refresh_token: \"BAR\",\n    },\n    expiresAt: Date.now() + 3600,\n  };\n\n  localStorage.setItem(\"sb-sb-auth-token\", JSON.stringify(fake));\n\n  // 2. Simulate Supabase auto-refresh firing at the same time\n  // (write half of a session object)\n  setTimeout(() => {\n    console.warn(\"ğŸ’¥ Injecting half-written sessionâ€¦\");\n\n    localStorage.setItem(\"sb-sb-auth-token\", \"{bad_json:\");\n  }, 5);\n\n  // 3. Simultaneously delete during login (replicate your original bug)\n  setTimeout(() => {\n    console.warn(\"ğŸ’£ Login page wiping keys at same momentâ€¦\");\n    localStorage.removeItem(\"sb-sb-auth-token\");\n  }, 5);\n}\n\n// Remove only corrupted keys\nfunction repairSupabaseStorage() {\n  const keys = Object.keys(localStorage);\n  let repaired = false;\n\n  keys.forEach((key) => {\n    if (\n      key === \"sb-sb-auth-token\" ||\n      key.includes(\"undefined\") ||\n      key.includes(\"null\") ||\n      (key.startsWith(\"sb-\") && !key.includes(\"-auth-token\"))\n    ) {\n      console.warn(\"ğŸ›‘ Deleting corrupted key:\", key);\n      localStorage.removeItem(key);\n      repaired = true;\n    } else if (key.startsWith(\"sb-\")) {\n      try {\n        JSON.parse(localStorage.getItem(key) || \"\");\n      } catch {\n        console.warn(\"ğŸ›‘ Invalid JSON in:\", key);\n        localStorage.removeItem(key);\n        repaired = true;\n      }\n    }\n  });\n\n  return repaired;\n}\n\n// Remove all Supabase keys\nfunction nukeSupabaseStorage() {\n  const keys = Object.keys(localStorage);\n  keys.forEach((k) => {\n    if (k.startsWith(\"sb-\")) {\n      console.warn(\"ğŸ’£ Removing Supabase key:\", k);\n      localStorage.removeItem(k);\n    }\n  });\n}\n\n\n// ======================================================\n// ğŸ” TEST USERS (example only)\n// ======================================================\nconst USERS = [\n  {\n    label: \"User1\",\n    email: \"user1@test.com\",\n    password: \"password1\",\n  },\n  {\n    label: \"User2\",\n    email: \"user2@test.com\",\n    password: \"password1\",\n  },\n] as const;\n\n\n// ======================================================\n// ğŸ”¬ PAGE COMPONENT\n// ======================================================\nexport default function AuthDebugger() {\n  const [log, setLog] = useState<string[]>([]);\n  const append = (msg: string) =>\n    setLog((prev) => [...prev, `[${new Date().toLocaleTimeString()}] ${msg}`]);\n\n  // -----------------------------------------------------\n  // ğŸ” Step 1 â€” Test: corrupt storage\n  // -----------------------------------------------------\n  const testCorrupt = () => {\n    corruptSupabaseStorage();\n    append(\"ğŸ’¥ Created corrupted Supabase storage entries.\");\n  };\n\n  // -----------------------------------------------------\n  // ğŸ” Step 2 â€” Test: repair storage\n  // -----------------------------------------------------\n  const testRepair = () => {\n    const fixed = repairSupabaseStorage();\n    append(fixed ? \"ğŸ›  Repaired storage!\" : \"ğŸ‘Œ Nothing to repair.\");\n  };\n\n  // -----------------------------------------------------\n  // ğŸ” Step 3 â€” Test: Nuke all session\n  // -----------------------------------------------------\n  const testNuke = () => {\n    nukeSupabaseStorage();\n    append(\"ğŸ’£ Nuked all Supabase storage keys.\");\n  };\n\n  // -----------------------------------------------------\n  // ğŸ” Step 4 â€” Test: Login\n  // -----------------------------------------------------\n  const testLogin = async (user: (typeof USERS)[number]) => {\n    append(`\\n=== ğŸ” LOGIN TEST (${user.label}) ===`);\n\n    const { error } = await supabase.auth.signInWithPassword({\n      email: user.email,\n      password: user.password,\n    });\n\n    if (error) {\n      append(`âŒ Login error: ${error.message}`);\n      return;\n    }\n\n    append(`âœ… Logged in as ${user.email}`);\n\n    const { data } = await supabase.auth.getSession();\n    append(\"ğŸ“¦ Session after login:\");\n    append(JSON.stringify(data, null, 2));\n  };\n\n  // -----------------------------------------------------\n  // ğŸ” Step 5 â€” Test: Session call\n  // -----------------------------------------------------\n  const testGetSession = async () => {\n    append(\"ğŸ” Fetching sessionâ€¦\");\n    const { data, error } = await supabase.auth.getSession();\n    if (error) append(\"âŒ \" + error.message);\n    append(JSON.stringify(data, null, 2));\n  };\n\n  // -----------------------------------------------------\n  // ğŸ” Step 6 â€” Test: Logout\n  // -----------------------------------------------------\n  const testLogout = async () => {\n    append(\"ğŸšª Logout test startedâ€¦\");\n\n    // Nuke storage first (simulate corrupted logout)\n    nukeSupabaseStorage();\n\n    const { error } = await supabase.auth.signOut();\n\n    if (error) {\n      append(\"âŒ Logout failed: \" + error.message);\n      return;\n    }\n\n    append(\"âœ… Successfully logged out and wiped storage.\");\n  };\n\n  // -----------------------------------------------------\n  // ğŸ” Step 7 â€” Test: Auto-Repair on Delay\n  // -----------------------------------------------------\n  const testTimedRepair = () => {\n    append(\"â³ Setting auto-repair timer (5s)â€¦\");\n    setTimeout(() => {\n      const repaired = repairSupabaseStorage();\n      append(repaired ? \"ğŸ›  Timer repair executed\" : \"ğŸ‘Œ Timer found no corruption\");\n    }, 5000);\n  };\n\n  // -----------------------------------------------------\n  // ğŸ” Step 8 â€” Inspect localStorage\n  // -----------------------------------------------------\n  const inspectStorage = () => {\n    append(\"ğŸ“¦ Current localStorage:\");\n    append(JSON.stringify(Object.keys(localStorage), null, 2));\n  };\n\n\n  // ======================================================\n  // ğŸ¨ UI\n  // ======================================================\n  return (\n    <div\n      style={{\n        padding: 20,\n        color: \"white\",\n        background: \"#111\",\n        fontFamily: \"monospace\",\n        minHeight: \"100vh\",\n      }}\n    >\n      <h1>ğŸ§ª Supabase Auth Debugger</h1>\n      <p>Use this page to break, inspect, repair, and test Supabase auth.</p>\n\n      <h2>ğŸ”§ Actions</h2>\n\n      <div style={{ display: \"flex\", gap: 10, flexWrap: \"wrap\" }}>\n        <button onClick={testCorrupt}>ğŸ’¥ Corrupt Storage</button>\n        <button onClick={testRepair}>ğŸ›  Repair Storage</button>\n        <button onClick={testNuke}>ğŸ’£ Nuke Storage</button>\n        <button onClick={inspectStorage}>ğŸ“¦ Inspect Storage</button>\n        <button onClick={testGetSession}>ğŸ” Get Session</button>\n        <button onClick={testLogout}>ğŸšª Logout</button>\n        <button onClick={testTimedRepair}>â³ Timed Repair</button>\n      </div>\n\n      <h2>ğŸ” Login Tests</h2>\n\n      <div style={{ display: \"flex\", gap: 10, flexWrap: \"wrap\" }}>\n        {USERS.map((u) => (\n          <button key={u.label} onClick={() => testLogin(u)}>\n            Login as {u.label}\n          </button>\n        ))}\n      </div>\n\n      <pre\n        style={{\n          marginTop: 20,\n          background: \"#000\",\n          padding: 15,\n          borderRadius: 8,\n          height: 500,\n          overflowY: \"auto\",\n          fontSize: 12,\n        }}\n      >\n        {log.join(\"\\n\")}\n      </pre>\n    </div>\n  );\n}\n"],"names":["repairSupabaseStorage","keys","Object","localStorage","repaired","forEach","key","includes","startsWith","console","warn","removeItem","JSON","parse","getItem","nukeSupabaseStorage","k","USERS","label","email","password","AuthDebugger","log","setLog","useState","append","msg","prev","Date","toLocaleTimeString","React","style","padding","color","background","fontFamily","minHeight","display","gap","flexWrap","onClick","testCorrupt","fake","currentSession","expires_at","now","access_token","refresh_token","expiresAt","setItem","stringify","setTimeout","corruptSupabaseStorage","testRepair","fixed","testNuke","inspectStorage","async","data","error","supabase","auth","getSession","message","signOut","testTimedRepair","map","u","user","signInWithPassword","testLogin","marginTop","borderRadius","height","overflowY","fontSize","join"],"sourceRoot":""}