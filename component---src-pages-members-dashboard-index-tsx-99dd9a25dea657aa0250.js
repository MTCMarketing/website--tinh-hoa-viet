"use strict";(self.webpackChunk=self.webpackChunk||[]).push([[7876],{7843:function(e,t,a){a.d(t,{A:function(){return n}});var l=a(6540);var n=e=>{let{url:t,width:a=100,height:n=100,alt:r="User Avatar",className:s=""}=e;const{0:i,1:o}=(0,l.useState)(!1),{0:c,1:m}=(0,l.useState)(!1),u=!t||c||""===t.trim()||!i;return l.createElement("img",{src:u?"data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjkwOSIgaGVpZ2h0PSIyOTA5IiB2aWV3Qm94PSIwIDAgMjkwOSAyOTA5IiBmaWxsPSJub25lIiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciPgo8cGF0aCBkPSJNMjkwOC42IDE0NTQuMjVDMjkwOC42IDIyNTcuNCAyMjU3LjQ4IDI5MDguNSAxNDU0LjMgMjkwOC41QzY1MS4xMiAyOTA4LjUgMCAyMjU3LjQgMCAxNDU0LjI1QzAgNjUxLjA5NyA2NTEuMTIgMCAxNDU0LjMgMEMyMjU3LjQ4IDAgMjkwOC42IDY1MS4wOTcgMjkwOC42IDE0NTQuMjVaIiBmaWxsPSIjRDdFMUUxIi8+CjxwYXRoIGQ9Ik0yMzY3LjkzIDI1MDUuMjRWMjU4NS42OUMyMTE4LjIzIDI3ODcuNTYgMTgwMC4zOSAyOTA4LjQ3IDE0NTQuMjcgMjkwOC40N0MxMTA4LjIyIDI5MDguNDcgNzkwLjMzOSAyNzg3LjU2IDU0MC42NyAyNTg1Ljc2VjI1MDUuMjRDNTQwLjY3IDIwNzAuNTEgODkzLjEwNSAxNzE4LjAyIDEzMjcuODUgMTcxOC4wMkgxNTgwLjcxQzIwMTUuNSAxNzE4LjAyIDIzNjcuOTMgMjA3MC41MSAyMzY3LjkzIDI1MDUuMjRaIiBmaWxsPSIjQTFBRUIwIi8+CjxwYXRoIGQ9Ik0xOTM3LjM2IDEwMjIuMjZDMTkzNy4zNiAxMjg5LjA0IDE3MjEuMDkgMTUwNS4zIDE0NTQuMyAxNTA1LjNDMTE4Ny41MSAxNTA1LjMgOTcxLjI0MSAxMjg5LjA0IDk3MS4yNDEgMTAyMi4yNkM5NzEuMjQxIDc1NS40NzMgMTE4Ny41MSA1MzkuMjEzIDE0NTQuMyA1MzkuMjEzQzE3MjEuMDkgNTM5LjIxMyAxOTM3LjM2IDc1NS40NzMgMTkzNy4zNiAxMDIyLjI2WiIgZmlsbD0iI0ExQUVCMCIvPgo8L3N2Zz4K":t,alt:r,width:a,height:n,className:"rounded-full object-cover "+s+" "+(u?"fallback-avatar":""),onLoad:()=>o(!0),onError:()=>m(!0),loading:"lazy"})}},9314:function(e,t,a){a.r(t),a.d(t,{default:function(){return g}});var l=a(6540),n=a(5458),r=a(3),s=a(8027);var i=a(7843),o=a(6898);async function c(e){try{console.log("ðŸŸ¡ updateUserProfile called with:",e);const{data:{session:t},error:a}=await o.ND.auth.getSession();if(a)throw a;if(null==t||!t.user)throw new Error("Not authenticated");const l=t.user.id;console.log("ðŸŸ¢ AUTH CHECK â†’",{userId:l});const n={},r={};if(void 0!==e.fullName&&(n.full_name=e.fullName),void 0!==e.field&&(n.field_of_expertise=e.field),void 0!==e.hometown&&(n.hometown=e.hometown),void 0!==e.title&&(n.title=e.title),void 0!==e.rank&&(n.rank=e.rank),void 0!==e.avatar&&(n.avatar_url=e.avatar),void 0!==e.membership_level&&(n.membership_level=e.membership_level),void 0!==e.profile_status&&(n.profile_status=e.profile_status),void 0!==e.email&&(r.email=e.email),void 0!==e.phone&&(r.phone=e.phone),void 0!==e.address&&(r.address=e.address),void 0!==e.dob&&(r.dob=e.dob),void 0!==e.goals&&(r.personal_goals=e.goals),void 0!==e.vision&&(r.future_vision=e.vision),void 0!==e.application_status&&(r.application_process=e.application_status),void 0!==e.profile_progress&&(r.profile_progress=e.profile_progress),console.log("ðŸŸ£ Split payloads â†’",{memberPayload:n,privatePayload:r}),Object.keys(n).length>0){const{error:e}=await o.ND.from("user_member_v2").update(Object.assign({},n,{updated_at:(new Date).toISOString()})).eq("id",l);if(e){console.warn("ðŸŸ  Update failed â†’ trying insert for member table:",e.message);const{error:t}=await o.ND.from("user_member_v2").insert(Object.assign({id:l},n));if(t)throw t}}if(Object.keys(r).length>0){const{error:e}=await o.ND.from("user_private_v2").update(Object.assign({},r,{updated_at:(new Date).toISOString()})).eq("id",l);if(e){console.warn("ðŸŸ  Update failed â†’ trying insert for private table:",e.message);const{error:t}=await o.ND.from("user_private_v2").insert(Object.assign({id:l},r));if(t)throw t}}return console.log("âœ… Both tables updated successfully (no re-fetch)"),{success:!0}}catch(t){return console.error("âŒ updateUserProfile failed:",t.message),{success:!1,error:t}}}var m=(0,l.memo)(e=>{let{field:t,userData:a,editingField:n,tempValue:s,onEditStart:i,onSave:o,onCancel:c,onTempValueChange:m,savingField:u,savingSidebar:d}=e;const p=n===t.key,v=u===t.key,g="dob"===t.key?"date":"email"===t.key?"email":"text";return l.createElement("div",{className:"profile-field"},l.createElement("label",null,t.icon,t.label),l.createElement("div",{className:"field-value"},p?l.createElement("div",{className:"edit-controls"},l.createElement("input",{type:g,value:s||"",onChange:e=>m(e.target.value),className:"edit-input",autoFocus:!0}),l.createElement("div",{className:"edit-actions"},l.createElement("button",{className:"save-btn",onClick:()=>o(t.key),disabled:!!u||d},v?l.createElement("span",{className:"spinner",style:{width:"16px",height:"16px",border:"2px solid #fff",borderTop:"2px solid transparent",borderRadius:"50%",display:"inline-block",animation:"spin 0.8s linear infinite"}}):l.createElement(r.Bc_,null)),l.createElement("button",{className:"cancel-btn",onClick:c,disabled:!!u||d},l.createElement(r.yGN,null)))):l.createElement(l.Fragment,null,l.createElement("span",null,"dob"===t.key&&a[t.key]?new Date(a[t.key]).toLocaleDateString():a[t.key]||"â€”"),l.createElement("button",{className:"edit-btn",onClick:()=>i(t.key,a[t.key]||""),disabled:!!u||d},l.createElement(r.SG1,null)))))});var u=(0,l.memo)(e=>{let{step:t,index:a,totalSteps:n}=e;return l.createElement("div",{className:"timeline-step "+(t.completed?"completed":"")+" "+(t.current?"current":"")},l.createElement("div",{style:{backgroundColor:"#001a33"},className:"step-marker"},t.completed?l.createElement(r.A3x,null):t.step),l.createElement("div",{className:"step-content"},l.createElement("h4",null,"Step ",t.step),l.createElement("p",null,t.label)),a<n-1&&l.createElement("div",{className:"step-connector"}))});var d=(0,l.memo)(e=>{let{item:t}=e;return l.createElement("div",{className:"history-item"},l.createElement("div",{className:"history-icon"},t.icon),l.createElement("div",{className:"history-content"},l.createElement("p",{className:"history-action"},t.action),l.createElement("span",{className:"history-time"},t.time)))});const p={fullName:"Nguyen Van A2",phone:"0901234567",email:"user1@test.com",dob:"1990-01-01",address:"123 Hue St",hometown:"Hue",title:"Cultural Enthusiast",rank:"Elite Member",field:"Cultural Research",goals:"Promote Vietnamese heritage globally",vision:"Bridge traditional and modern culture through technology",application_status:"Step 2: Under review by Editorial Department"};var v=()=>{const{0:e,1:t}=(0,l.useState)(p),{0:a,1:v}=(0,l.useState)(null),{0:g,1:E}=(0,l.useState)(""),{0:N,1:y}=(0,l.useState)(""),{0:b,1:f}=(0,l.useState)(!0),{0:h,1:M}=(0,l.useState)(null),{0:k,1:w}=(0,l.useState)(!1),{0:j,1:S}=(0,l.useState)(!1),{0:D,1:I}=(0,l.useState)(Object.assign({},p)),{0:A,1:x}=(0,l.useState)([]),_=(0,l.useRef)(null),{0:C,1:O}=(0,l.useState)([{step:1,label:"Profile Submitted",completed:!1,current:!1},{step:2,label:"Under Review",completed:!1,current:!1},{step:3,label:"Evaluation",completed:!1,current:!1},{step:4,label:"Approved",completed:!1,current:!1}]),{0:T,1:L}=(0,l.useState)(0),z=(0,l.useRef)(!1);(0,l.useEffect)(()=>{if(z.current)return;z.current=!0;(async()=>{console.log("âš¡ Dashboard initialized â€” attempting user load"),f(!0);try{const e=await async function(e){let{debug:t=!1,timeoutMs:a=5e3,redirectTo:l="/sign-in"}=void 0===e?{}:e;const n=function(){for(var e,a=arguments.length,l=new Array(a),n=0;n<a;n++)l[n]=arguments[n];return t&&(e=console).log.apply(e,["[getUserSafe]"].concat(l))};try{var r,s;const{data:e}=await o.ND.auth.getSession(),t=null==e||null===(r=e.session)||void 0===r?void 0:r.user;if(t)return n("âœ… got user from cached session:",t.email),t;const l=new Promise((e,t)=>setTimeout(()=>t(new Error("â° auth.getUser() stalled")),a)),{data:i,error:c}=await Promise.race([o.ND.auth.getUser(),l]);if(c)throw c;if(null!=i&&i.user)return n("âœ… got user via getUser()"),i.user;n("ðŸ”„ attempting session refreshâ€¦");const{error:m,data:u}=await o.ND.auth.refreshSession();if(!m&&null!=u&&null!==(s=u.session)&&void 0!==s&&s.user)return n("âœ… refreshed session, user:",u.session.user.email),u.session.user;throw new Error("âŒ No valid user after refresh")}catch(i){n("âš ï¸ auth error:",i.message);try{await o.ND.auth.signOut(),Object.keys(localStorage).filter(e=>e.startsWith("sb-")&&e.includes("auth-token")).forEach(e=>localStorage.removeItem(e)),n("ðŸ§¼ cleared stale tokens")}catch(c){}return"undefined"!=typeof window&&(n("âž¡ï¸ redirecting to sign-in"),window.location.replace(l+"?reason=session_repair")),null}}({debug:!0,timeoutMs:8e3,defaultUser:p});if(null==e||!e.id)return void console.warn("ðŸš« No valid session, redirected by getUserSafe()");console.log("ðŸ‘¤ Logged-in user:",e),console.log("ðŸ§© Fetching & merging user dataâ€¦");const a=await async function(e,t){var a,l,r,s,i,c,m,u,d,p,v,g,E,N,y,b,f,h;void 0===t&&(t=!1),t&&console.log("ðŸš€ mergeUserData() called for userId="+e);const[M,k,w]=await Promise.all([o.ND.from("user_member_v2").select("*").eq("id",e).maybeSingle(),o.ND.from("user_private_v2").select("*").eq("id",e).maybeSingle(),o.ND.from("user_credentials").select("*").eq("user_id",e).maybeSingle()]),j=M.data||{},S=k.data||{},D=w.data||{};t&&(console.group("ðŸ“‚ Raw data for "+e),console.log("A (user_member_v2):",j),console.log("B (user_private_v2):",S),console.log("C (user_credentials):",D),console.groupEnd());const I={id:e,fullName:null!==(a=j.full_name)&&void 0!==a?a:null,hometown:null!==(l=j.hometown)&&void 0!==l?l:null,title:null!==(r=j.title)&&void 0!==r?r:null,rank:null!==(s=j.rank)&&void 0!==s?s:null,field:null!==(i=j.field_of_expertise)&&void 0!==i?i:null,avatar:null!==(c=j.avatar_url)&&void 0!==c?c:null,membership_level:null!==(m=j.membership_level)&&void 0!==m?m:null,profile_status:null!==(u=j.profile_status)&&void 0!==u?u:null,email:null!==(d=null!==(p=S.email)&&void 0!==p?p:D.email)&&void 0!==d?d:null,phone:null!==(v=null!==(g=S.phone)&&void 0!==g?g:D.phone)&&void 0!==v?v:null,address:null!==(E=S.address)&&void 0!==E?E:null,dob:null!==(N=S.dob)&&void 0!==N?N:null,goals:null!==(y=S.personal_goals)&&void 0!==y?y:null,vision:null!==(b=S.future_vision)&&void 0!==b?b:null,application_process:null!==(f=S.application_process)&&void 0!==f?f:null,profile_progress:null!==(h=S.profile_progress)&&void 0!==h?h:0};if(t){const t=Array.from(new Set([].concat((0,n.A)(Object.keys(j)),(0,n.A)(Object.keys(S)),(0,n.A)(Object.keys(D)))));for(const e of t){const t={A:j[e],B:S[e],C:D[e]},a=Object.entries(t).filter(e=>{let[,t]=e;return null!=t&&""!==t});a.length>1&&console.log('âš ï¸ Collision: "'+e+'" in '+a.map(e=>{let[t]=e;return t}).join(", ")+" â†’",a.map(e=>{let[t,a]=e;return t+": "+JSON.stringify(a)}).join(" | "))}console.group("ðŸ§© Merge Summary for "+e),console.table(Object.entries(I).map(e=>{let[t,a]=e;return{column:t,A:j[t],B:S[t],C:D[t],chosen:a}})),console.groupEnd(),console.log("âœ… mergeUserData complete")}return I}(e.id,!0);console.log("âœ… Final merged data:",a);const l=a.application_process?Math.min(Number(a.application_process),4):1;O(e=>e.map(e=>Object.assign({},e,{completed:e.step<l,current:e.step===l}))),L(Math.round(l/4*100)),t(a),I(a),a.avatar&&y(a.avatar),x([]),localStorage.setItem("user",JSON.stringify(a))}catch(e){console.error("ðŸ’¥ Failed to load profile:",e),t(p)}finally{f(!1)}})()},[]);const U=(e,t)=>{v(e),E(t)},P=async a=>{try{var l;M(a);const n=Object.assign({},e,{[a]:g});t(n),localStorage.setItem("user",JSON.stringify(n));const r=await c({[a]:g});r.success?v(null):alert("âŒ Failed: "+(null===(l=r.error)||void 0===l?void 0:l.message))}catch(n){alert("âŒ Save failed: "+n.message)}finally{M(null)}},F=()=>{v(null),E("")};return b?l.createElement("div",{className:"dashboard-loading"},l.createElement("div",{className:"loading-spinner"}),l.createElement("p",null,"Loading your dashboard...")):l.createElement("div",{className:"luxury-dashboard"},l.createElement("header",{className:"dashboard-header"},l.createElement("div",{className:"header-content"},l.createElement("div",{className:"brand-section"},l.createElement("h1",null,"Cultural Excellence Dashboard")),l.createElement("div",{className:"header-actions"},l.createElement("button",{className:"header-btn",onClick:()=>window.location.href="/"},l.createElement(r.V5Y,null),l.createElement("span",null,"Home")),l.createElement("button",{className:"header-btn",onClick:()=>window.location.href="/members/dashboard/message"},l.createElement(r.JXP,null),l.createElement("span",null,"Messages")),l.createElement("button",{className:"header-btn logout",onClick:()=>window.location.href="/sign-out"},l.createElement(r.QeK,null),l.createElement("span",null,"Logout"))))),l.createElement("div",{className:"dashboard-content"},l.createElement("div",{className:"content-grid"},l.createElement("div",{className:"left-column"},l.createElement("div",{className:"profile-card luxury-card"},l.createElement("div",{className:"card-header"},l.createElement("h2",null,"Profile Overview"),l.createElement("div",{className:"status-badge"},l.createElement(r.A3x,null),l.createElement("span",null,"Active Member"))),l.createElement("div",{className:"avatar-section"},l.createElement("div",{className:"avatar-container",onClick:()=>{var e;return null===(e=_.current)||void 0===e?void 0:e.click()}},l.createElement(i.A,{url:N||"/default-avatar.png",width:100,height:100,className:"profile-avatar"}),false),l.createElement("div",{className:"avatar-info"},l.createElement("h3",null,e.fullName),l.createElement("p",{className:"user-title"},e.title),l.createElement("div",{className:"rating"},(0,n.A)(Array(5)).map((e,t)=>l.createElement(s.gt3,{key:t})),l.createElement("span",null,e.rank)))),l.createElement("div",{className:"profile-details"},[{key:"fullName",label:"Full Name",icon:l.createElement(r.JXP,null)},{key:"phone",label:"Phone Number",icon:l.createElement(s.tz0,null)},{key:"email",label:"Email",icon:l.createElement(r.JXP,null)},{key:"dob",label:"Date of Birth",icon:l.createElement(s.Z0L,null)},{key:"address",label:"Address",icon:l.createElement(r.V5Y,null)},{key:"hometown",label:"Hometown",icon:l.createElement(s.tz0,null)},{key:"field",label:"Field of Expertise",icon:l.createElement(s.Z0L,null)}].map(t=>l.createElement(m,{key:t.key,field:t,userData:e,editingField:a,tempValue:g,onEditStart:U,onSave:P,onCancel:F,onTempValueChange:E,savingField:h,savingSidebar:k})))),l.createElement("div",{className:"status-card luxury-card"},l.createElement("div",{className:"card-header"},l.createElement("h2",null,"Application Progress"),l.createElement("div",{className:"progress-text"},T,"% Complete")),l.createElement("div",{className:"timeline"},C.map((e,t)=>l.createElement(u,{key:e.step,step:e,index:t,totalSteps:C.length}))))),l.createElement("div",{className:"right-column"},l.createElement("div",{className:"goals-card luxury-card"},l.createElement("div",{className:"card-header"},l.createElement("h2",null,"Goals & Vision")),l.createElement("div",{className:"goals-content"},["goals","vision"].map(t=>l.createElement("div",{className:"vision-field",key:t},l.createElement("label",null,"goals"===t?"Personal Goals":"Future Vision"),l.createElement("div",{className:"field-value"},a===t?l.createElement("div",{className:"edit-controls"},l.createElement("textarea",{value:g,onChange:e=>E(e.target.value),rows:3,className:"edit-textarea"}),l.createElement("div",{className:"edit-actions"},l.createElement("button",{className:"save-btn",onClick:()=>P(t),disabled:!!h||k},h===t?l.createElement("span",{className:"spinner"}):l.createElement(r.Bc_,null)),l.createElement("button",{className:"cancel-btn",onClick:F,disabled:!!h||k},l.createElement(r.yGN,null)))):l.createElement(l.Fragment,null,l.createElement("p",null,e[t]),l.createElement("button",{className:"edit-btn",onClick:()=>U(t,e[t]),disabled:!!h||k},l.createElement(r.SG1,null)))))))),l.createElement("div",{className:"history-card luxury-card"},l.createElement("div",{className:"card-header"},l.createElement("h2",null,l.createElement(s.OKX,null)," Recent Activity")),l.createElement("div",{className:"history-list"},A.length>0?A.map((e,t)=>l.createElement(d,{key:t,item:{action:e.action,time:new Date(e.created_at).toLocaleString(),icon:l.createElement(s.A7C,null)}})):l.createElement("div",{className:"status-header"},l.createElement("p",{className:"no-activity"},"No recent activity")))),false))),!j&&l.createElement("button",{className:"floating-edit-btn",onClick:()=>S(!0),title:"Edit Profile"},l.createElement(r.SG1,null)),l.createElement("div",{className:"edit-sidebar "+(j?"open":"")},l.createElement("div",{className:"edit-sidebar-header"},l.createElement("h3",null,"Edit Profile"),l.createElement("button",{className:"close-sidebar",onClick:()=>S(!1)},l.createElement(r.yGN,null))),l.createElement("div",{className:"edit-sidebar-content"},[{key:"fullName",label:"Full Name",type:"text"},{key:"phone",label:"Phone Number",type:"text"},{key:"email",label:"Email",type:"email"},{key:"dob",label:"Date of Birth",type:"date"},{key:"address",label:"Address",type:"text"},{key:"hometown",label:"Hometown",type:"text"},{key:"field",label:"Field of Expertise",type:"text"},{key:"goals",label:"Personal Goals",type:"textarea"},{key:"vision",label:"Future Vision",type:"textarea"}].map(e=>l.createElement("div",{className:"profile-field",key:e.key},l.createElement("label",null,e.label),"textarea"===e.type?l.createElement("textarea",{className:"edit-input",rows:3,value:D[e.key],onChange:t=>I(Object.assign({},D,{[e.key]:t.target.value}))}):l.createElement("input",{type:e.type,className:"edit-input",value:D[e.key],onChange:t=>I(Object.assign({},D,{[e.key]:t.target.value}))}))),l.createElement("button",{className:"save-sidebar-btn",onClick:async()=>{try{var e;w(!0),t(D),localStorage.setItem("user",JSON.stringify(D));const a=await c(D);a.success?(S(!1),alert("âœ… Saved!")):alert("âŒ Failed: "+(null===(e=a.error)||void 0===e?void 0:e.message))}finally{w(!1)}},disabled:k||!!h},k?l.createElement("span",{className:"spinner"}):l.createElement(r.Bc_,{style:{marginRight:"8px"}}),"Save Changes"))))},g=()=>l.createElement(v,null)}}]);
//# sourceMappingURL=component---src-pages-members-dashboard-index-tsx-99dd9a25dea657aa0250.js.map