{"version":3,"file":"component---src-pages-test-dm-access-tsx-f5a690a97fd78bf24b5f.js","mappings":"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","sources":["webpack:///./src/pages/test/dm-access.tsx"],"sourcesContent":["\"use client\";\nimport React, { useState } from \"react\";\nimport { supabase } from \"../../database/supabaseClient\";\n\n/**\n * üîê TEST USERS\n * Replace passwords with valid ones for your test accounts.\n */\nconst USERS = [\n  {\n    label: \"admin\",\n    email: \"admin@tinhhoaviet.org.vn\",\n    password: \"FPyV9sXAxX9XhK4\", // change to real one\n  },\n  {\n    label: \"member_user1\",\n    email: \"user1@test.com\",\n    password: \"password1\",\n  },\n  {\n    label: \"member_slapkommerce\",\n    email: \"slapkommerce@gmail.com\",\n    password: \"password1\",\n  },\n] as const;\n\nexport default function DMAccessTest() {\n  const [log, setLog] = useState<string[]>([]);\n  const append = (msg: string) =>\n    setLog((prev) => [...prev, `[${new Date().toLocaleTimeString()}] ${msg}`]);\n\n  const runTest = async (user: (typeof USERS)[number]) => {\n    append(`\\n=== Testing as ${user.label} ===`);\n    try {\n      // 1Ô∏è‚É£ Login\n      const { error: loginErr } = await supabase.auth.signInWithPassword({\n        email: user.email,\n        password: user.password,\n      });\n      if (loginErr) {\n        append(`‚ùå Login failed for ${user.email}: ${loginErr.message}`);\n        return;\n      }\n\n      const {\n        data: { user: loggedUser },\n      } = await supabase.auth.getUser();\n      const uid = loggedUser?.id ?? \"unknown\";\n      append(`‚úÖ Logged in as ${user.email} (uid: ${uid})`);\n\n      // 2Ô∏è‚É£ Fetch all visible dm_messages\n      append(\"üîç SELECT * FROM dm_messages\");\n      const { data: messages, error: readErr } = await supabase\n        .from(\"dm_messages\")\n        .select(\"*\")\n        .order(\"created_at\", { ascending: false });\n\n      if (readErr) {\n        append(`üö´ Read error: ${readErr.message}`);\n      } else {\n        append(\n          `üì® Retrieved ${messages?.length ?? 0} message(s) visible to ${user.label}`\n        );\n        if (messages?.length)\n          append(`üßæ Sample:\\n${JSON.stringify(messages.slice(0, 3), null, 2)}`);\n        else append(\"‚ÑπÔ∏è No messages visible (likely correct for restricted user)\");\n      }\n\n      // 3Ô∏è‚É£ Attempt to read specific Admin‚ÜíSlapkommerce message\n      const ADMIN_ID = \"6c77d859-1af1-418e-b0e0-0d3cc4e80fad\";\n      const SLAPKOMMERCE_ID = \"d3ca3641-e106-4a4d-a288-bb3e0c4e3a9a\";\n\n      append(\n        `üîç Checking if ${user.label} can read message between ADMIN ‚Üí slapkommerce`\n      );\n      const { data: specificMsg, error: specErr } = await supabase\n        .from(\"dm_messages\")\n        .select(\"*\")\n        .eq(\"sender_id\", ADMIN_ID)\n        .eq(\"recipient_id\", SLAPKOMMERCE_ID);\n\n      if (specErr) {\n        append(`üö´ Direct query failed: ${specErr.message}`);\n      } else if (specificMsg && specificMsg.length > 0) {\n        append(\n          `‚ö†Ô∏è SECURITY ALERT: ${user.label} can see ${specificMsg.length} message(s) between admin and slapkommerce!`\n        );\n      } else {\n        append(`‚úÖ Access denied (as expected ‚Äî cannot read others‚Äô DMs)`);\n      }\n\n      await supabase.auth.signOut();\n      append(`--- End test for ${user.label} --- ‚úÖ`);\n    } catch (err: any) {\n      append(`‚ùå Unexpected error for ${user.label}: ${err.message}`);\n      console.error(err);\n      await supabase.auth.signOut();\n    }\n  };\n\n  return (\n    <div\n      style={{\n        fontFamily: \"monospace\",\n        padding: 20,\n        maxWidth: 900,\n        margin: \"auto\",\n        color: \"#eee\",\n      }}\n    >\n      <h2>üîí DM Access Test (Admin ‚Üî Member Visibility)</h2>\n\n      <div style={{ display: \"flex\", gap: 8, flexWrap: \"wrap\" }}>\n        {USERS.map((u) => (\n          <button\n            key={u.email}\n            onClick={() => runTest(u)}\n            style={{\n              padding: \"8px 12px\",\n              background: \"#333\",\n              border: \"1px solid #555\",\n              borderRadius: 6,\n              cursor: \"pointer\",\n              color: \"lime\",\n            }}\n          >\n            Test as {u.label}\n          </button>\n        ))}\n      </div>\n\n      <pre\n        style={{\n          background: \"#000\",\n          color: \"#0f0\",\n          padding: 15,\n          borderRadius: 8,\n          marginTop: 20,\n          height: 400,\n          fontSize: 12,\n          overflowY: \"auto\",\n          whiteSpace: \"pre-wrap\",\n        }}\n      >\n        {log.join(\"\\n\")}\n      </pre>\n\n      {/* üß† EXPLAINER SECTION */}\n      <div\n        style={{\n          background: \"#111\",\n          border: \"1px solid #333\",\n          borderRadius: 8,\n          padding: 20,\n          marginTop: 15,\n          lineHeight: 1.6,\n        }}\n      >\n        <h3 style={{ color: \"gold\" }}>üß≠ What this test does</h3>\n        <ul style={{ paddingLeft: 20, fontSize : 12 }}>\n          <li>\n            Logs in as three roles: <b>admin</b>, <b>member_user1</b>, and{\" \"}\n            <b>member_slapkommerce</b>.\n          </li>\n          <li>\n            Each user runs <code>SELECT * FROM dm_messages</code> to see which\n            messages are visible under Row Level Security.\n          </li>\n          <li>\n            It specifically checks whether{\" \"}\n            <b>user1@test.com</b> can see the private DM between{\" \"}\n            <b>admin@tinhhoaviet.org.vn</b> and{\" \"}\n            <b>slapkommerce@gmail.com</b>.\n          </li>\n        </ul>\n        <br/>\n        <h3 style={{ color: \"lime\" }}>‚úÖ Expected Results (Correct Behavior)</h3>\n       <ul style={{ paddingLeft: 20, fontSize : 12 }}>\n          <li>\n            <b>Admin</b> ‚Äî Sees <i>all</i> DM messages in the system.\n          </li>\n          <li>\n            <b>Member (slapkommerce)</b> ‚Äî Sees only their own conversation with\n            admin.\n          </li>\n          <li>\n            <b>Member (user1)</b> ‚Äî Sees only their own messages; cannot see\n            messages between admin and other users.\n          </li>\n        </ul>\n        <br/>\n        <h3 style={{ color: \"red\" }}>üö® Security Alert Indicators</h3>\n        <p style={{ marginLeft: 20,  fontSize : 12 }}>\n          If you see a line like{\" \"}\n          <code>‚ö†Ô∏è SECURITY ALERT: user1 can see messages between admin and slapkommerce</code>\n          , that means your RLS policy is too permissive and should be reviewed.\n        </p>\n        <br/>\n        <p style={{ marginTop: 10, color: \"#ccc\",  fontSize : 12 }}>\n          This component acts as a live verification tool ‚Äî if all tests log\n          ‚Äú‚úÖ Access denied (as expected)‚Äù for unrelated users, your messaging\n          privacy setup is solid. üõ°Ô∏è\n        </p>\n      </div>\n    </div>\n  );\n}\n"],"names":["USERS","label","email","password","DMAccessTest","log","setLog","useState","append","msg","prev","Date","toLocaleTimeString","React","style","fontFamily","padding","maxWidth","margin","color","display","gap","flexWrap","map","u","key","onClick","async","user","error","loginErr","supabase","auth","signInWithPassword","message","data","loggedUser","getUser","uid","id","messages","readErr","from","select","order","ascending","length","JSON","stringify","slice","ADMIN_ID","SLAPKOMMERCE_ID","specificMsg","specErr","eq","signOut","err","console","runTest","background","border","borderRadius","cursor","marginTop","height","fontSize","overflowY","whiteSpace","join","lineHeight","paddingLeft","marginLeft"],"sourceRoot":""}